
# Пошаговая инструкция по деплою проекта в VK Cloud

## Подготовительный этап

### Шаг 1: Регистрация в VK Cloud
1. Откройте браузер и перейдите на сайт [VK Cloud](https://mcs.mail.ru/)
2. Нажмите кнопку "Регистрация" в правом верхнем углу
3. Заполните все необходимые поля
4. Подтвердите адрес электронной почты, перейдя по ссылке в письме
5. Войдите в аккаунт, используя свои учетные данные

### Шаг 2: Создание проекта в VK Cloud
1. На главной странице нажмите кнопку "Создать проект"
2. Введите название проекта, например, "rodnik-app"
3. Выберите "Публичный облачный проект"
4. Нажмите "Создать"

### Шаг 3: Пополнение баланса проекта
1. В меню слева перейдите в раздел "Баланс"
2. Нажмите "Пополнить счет"
3. Выберите удобный способ оплаты (карта или ЮMoney)
4. Внесите минимальную сумму (обычно от 1000 рублей)
5. Завершите оплату

## Настройка окружения

### Шаг 4: Подготовка окружения для деплоя
1. Откройте файл `environment.env.example` в корне проекта
2. Создайте новый файл `environment.env` на его основе
3. Заполните все необходимые переменные окружения:

```
# Основные настройки
DEBUG=0
SECRET_KEY=замените_на_случайную_строку
ALLOWED_HOSTS=вставьте_домен_или_ip

# База данных
DB_NAME=rodnik_db
DB_USER=postgres
DB_PASSWORD=надежный_пароль
DB_HOST=db
DB_PORT=5432

# WebSocket настройки
WEBSOCKET_URL=ws://ваш_домен:8001
NEXT_PUBLIC_WEBSOCKET_URL=wss://ваш_домен/ws
NEXT_PUBLIC_API_URL=https://ваш_домен
```

## Настройка VK Cloud для развертывания проекта

### Шаг 5: Создание виртуальной машины
1. В меню VK Cloud перейдите в "Виртуальные машины" → "Создать"
2. Настройте параметры:
   - Имя: rodnik-server
   - Зона доступности: любая удобная
   - Операционная система: Ubuntu 20.04
   - Тип диска: SSD
   - Размер диска: 40 ГБ
   - Конфигурация: 2 vCPU, 4 ГБ RAM
3. Создайте или используйте существующую SSH-пару ключей
4. Нажмите "Создать"

### Шаг 6: Настройка сетевого доступа
1. В меню выберите "Сеть" → "Плавающие IP"
2. Назначьте плавающий IP вашей виртуальной машине
3. Перейдите в "Группы безопасности" → выберите вашу ВМ
4. Добавьте правила для входящего трафика:
   - HTTP (порт 80)
   - HTTPS (порт 443)
   - SSH (порт 22)
   - WebSocket (порт 8001)

## Подключение к серверу и установка необходимого ПО

### Шаг 7: Подключение к серверу
1. Откройте терминал на вашем компьютере
2. Введите команду:
   ```
   ssh -i путь_к_вашему_ssh_ключу ubuntu@ваш_плавающий_IP
   ```
3. Подтвердите подключение, если появится сообщение о fingerprint

### Шаг 8: Установка Docker и Docker Compose
1. Обновите список пакетов:
   ```
   sudo apt update && sudo apt upgrade -y
   ```

2. Установите необходимые пакеты:
   ```
   sudo apt install -y apt-transport-https ca-certificates curl software-properties-common
   ```

3. Добавьте ключ GPG для Docker:
   ```
   curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
   ```

4. Добавьте репозиторий Docker:
   ```
   sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
   ```

5. Установите Docker:
   ```
   sudo apt update && sudo apt install -y docker-ce docker-ce-cli containerd.io
   ```

6. Установите Docker Compose:
   ```
   sudo curl -L "https://github.com/docker/compose/releases/download/v2.23.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
   ```

7. Сделайте Docker Compose исполняемым:
   ```
   sudo chmod +x /usr/local/bin/docker-compose
   ```

8. Добавьте текущего пользователя в группу docker:
   ```
   sudo usermod -aG docker $USER
   ```

9. Перезагрузите сессию или сервер:
   ```
   newgrp docker
   ```

## Загрузка и настройка проекта

### Шаг 9: Клонирование проекта на сервер
1. Установите git:
   ```
   sudo apt install git -y
   ```

2. Клонируйте репозиторий (замените на URL вашего репозитория):
   ```
   git clone https://github.com/ваш_пользователь/deploy-trpo.git
   ```

3. Перейдите в директорию проекта:
   ```
   cd deploy-trpo
   ```

### Шаг 10: Настройка файлов проекта
1. Скопируйте файл environment.env.example в environment.env:
   ```
   cp environment.env.example environment.env
   ```

2. Отредактируйте файл environment.env с помощью nano:
   ```
   nano environment.env
   ```

3. Заполните все необходимые переменные окружения, используя данные, указанные в шаге 4
4. Сохраните изменения: Ctrl+O, затем Enter, и выйдите: Ctrl+X

## Запуск проекта с помощью Docker Compose

### Шаг 11: Настройка и запуск Docker Compose
1. Изучите и при необходимости отредактируйте docker-compose.yml:
   ```
   nano docker-compose.yml
   ```

2. Убедитесь, что все настройки сервисов (backend, frontend, nginx, db, websocket) соответствуют вашим требованиям

3. Соберите и запустите контейнеры с помощью Docker Compose:
   ```
   docker-compose up -d
   ```

4. Проверьте, что все контейнеры запущены:
   ```
   docker-compose ps
   ```

### Шаг 12: Инициализация базы данных
1. Выполните миграции базы данных:
   ```
   docker-compose exec backend python manage.py migrate
   ```

2. Создайте суперпользователя для административного доступа:
   ```
   docker-compose exec backend python manage.py createsuperuser
   ```

3. Следуйте инструкциям на экране для создания аккаунта администратора

## Настройка Nginx и SSL

### Шаг 13: Настройка домена
1. Приобретите домен через любого регистратора доменов
2. Настройте A-запись, указывающую на плавающий IP вашего сервера в VK Cloud

### Шаг 14: Настройка SSL с помощью Certbot
1. Установите Certbot и плагин Nginx:
   ```
   sudo apt install -y certbot python3-certbot-nginx
   ```

2. Получите SSL-сертификат:
   ```
   sudo certbot --nginx -d ваш_домен
   ```

3. Следуйте инструкциям Certbot для получения и установки сертификата
4. Certbot автоматически настроит Nginx для использования SSL

### Шаг 15: Проверка настройки Nginx
1. Проверьте конфигурацию Nginx:
   ```
   sudo nginx -t
   ```

2. Если конфигурация корректна, перезапустите Nginx:
   ```
   sudo systemctl restart nginx
   ```

## Проверка работоспособности проекта

### Шаг 16: Проверка работы сайта
1. Откройте браузер и перейдите по адресу `https://ваш_домен`
2. Убедитесь, что сайт загружается корректно
3. Проверьте функциональность WebSocket, открыв документ с совместным редактированием
4. Проверьте все основные функции приложения

### Шаг 17: Настройка мониторинга и автоматического перезапуска
1. Создайте скрипт для проверки работоспособности сервисов:
   ```
   nano /home/ubuntu/check_services.sh
   ```

2. Добавьте следующий код:
   ```bash
   #!/bin/bash
   cd /home/ubuntu/deploy-trpo
   docker-compose ps | grep -q "Exit" && docker-compose restart
   ```

3. Сделайте скрипт исполняемым:
   ```
   chmod +x /home/ubuntu/check_services.sh
   ```

4. Добавьте задачу в cron для регулярной проверки:
   ```
   crontab -e
   ```

5. Добавьте следующую строку для запуска проверки каждые 5 минут:
   ```
   */5 * * * * /home/ubuntu/check_services.sh
   ```

## Настройка резервного копирования

### Шаг 18: Настройка резервного копирования базы данных
1. Создайте скрипт для резервного копирования:
   ```
   nano /home/ubuntu/backup.sh
   ```

2. Добавьте следующий код:
   ```bash
   #!/bin/bash
   BACKUP_DIR="/home/ubuntu/backups"
   DATE=$(date +%Y-%m-%d_%H-%M-%S)
   mkdir -p $BACKUP_DIR
   
   # Backup PostgreSQL database
   cd /home/ubuntu/deploy-trpo
   docker-compose exec -T db pg_dump -U postgres rodnik_db > $BACKUP_DIR/rodnik_db_$DATE.sql
   
   # Delete backups older than 7 days
   find $BACKUP_DIR -type f -name "*.sql" -mtime +7 -delete
   ```

3. Сделайте скрипт исполняемым:
   ```
   chmod +x /home/ubuntu/backup.sh
   ```

4. Добавьте задачу в cron для ежедневного резервного копирования:
   ```
   crontab -e
   ```

5. Добавьте строку для запуска резервного копирования каждый день в 2 часа ночи:
   ```
   0 2 * * * /home/ubuntu/backup.sh
   ```

## Заключение

### Шаг 19: Проверка и тестирование
1. Проверьте работу всех функций приложения:
   - Регистрация и авторизация пользователей
   - Создание и редактирование документов
   - Работа WebSocket для совместного редактирования
   - Загрузка изображений и других медиафайлов

2. Убедитесь, что все сервисы работают корректно:
   ```
   docker-compose logs
   ```

Поздравляю! Вы успешно развернули проект Rodnik на платформе VK Cloud. Теперь ваше приложение доступно по адресу `https://ваш_домен` и готово к использованию.
